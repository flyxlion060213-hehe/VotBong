<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vợt Bóng - Pong (HTML) - Fixed</title>
  <style>
    :root{
      --bg:#08303a;--panel:#0f5f72;--bat:#20b2aa;--ball:#ff69b4;--text:#e6f6f8;
      --modal-bg: rgba(0,0,0,0.6);
    }
    body{margin:0;display:flex;align-items:center;justify-content:center;height:100vh;background:linear-gradient(180deg,#021b22,#04323a);font-family:system-ui,Segoe UI,Roboto,Arial}
    #gameWrap{background:var(--panel);padding:12px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.5);width:max-content}
    canvas{display:block;border-radius:8px;background:linear-gradient(180deg,#0f6b82,#074b5b);cursor:default}
    #hud{color:var(--text);text-align:center;margin-top:10px;display:flex;gap:12px;align-items:center;justify-content:center}
    button{padding:8px 12px;border-radius:8px;border:none;background:#fff;color:#123;cursor:pointer}
    .small{font-size:13px;color:#d9f0f2}

    /* Simple modal (non-blocking) */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: var(--modal-bg);
      z-index: 40;
    }
    .modal .card {
      background: linear-gradient(180deg,#0f6b82,#074b5b);
      color: var(--text);
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      text-align:center;
      min-width: 260px;
    }
    .modal .card h3 { margin: 0 0 8px 0; font-size: 18px; }
    .modal .card p { margin: 0 0 14px 0; color: #d9f0f2; }
    .modal.show { display:flex; }
  </style>
</head>
<body>
  <div id="gameWrap">
    <canvas id="game" width="750" height="500" aria-label="Vợt Bóng"></canvas>
    <div id="hud">
      <div class="small">Điểm: <strong id="score">0</strong></div>
      <button id="reset">Reset</button>
      <div class="small">Phím: ← →</div>
    </div>
  </div>

  <!-- Non-blocking modal thay confirm -->
  <div id="gameOverModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="card">
      <h3 id="modalTitle">Bạn thua!</h3>
      <p id="modalText">Điểm: 0</p>
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="playAgain">Chơi lại</button>
        <button id="closeModal">Thoát</button>
      </div>
    </div>
  </div>

  <script>
    // HTML/JS Pong - phiên bản đã sửa: tránh rAF chồng, xử lý va chạm, modal non-blocking, reset phím on blur.

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const resetBtn = document.getElementById('reset');

    const modal = document.getElementById('gameOverModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalText = document.getElementById('modalText');
    const playAgainBtn = document.getElementById('playAgain');
    const closeModalBtn = document.getElementById('closeModal');

    const W = canvas.width, H = canvas.height;

    // cấu hình (dễ điều chỉnh)
    const config = {
      batW: 80, batH: 12, batY: H - 40, batSpeed: 5,
      ballR: 7,
      startVx: 2.2, startVy: -2.6,
    };

    let bat = {x: 10, y: config.batY, w: config.batW, h: config.batH, speed: config.batSpeed};
    let ball = {x: 60, y: config.batY - 20, vx: config.startVx, vy: config.startVy, r: config.ballR};
    let leftPressed=false, rightPressed=false;
    let score=0, bounceCount=0;
    let running=true;

    // Raf id to avoid multiple requestAnimationFrame
    let rafId = null;

    // vẽ
    function drawBackground(){
      ctx.clearRect(0,0,W,H);
      // nhẹ nhàng glow/grid
      ctx.fillStyle = 'rgba(255,255,255,0.02)';
      ctx.fillRect(0,0,W,H);
    }
    function drawBat(){
      ctx.fillStyle = '#20b2aa';
      roundRect(ctx, bat.x, bat.y, bat.w, bat.h, 6, true, false);
    }
    function drawBall(){
      ctx.beginPath();
      ctx.fillStyle = '#ff69b4';
      ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
      ctx.fill();
    }
    function roundRect(ctx,x,y,w,h,r,fill,stroke){
      if (typeof r === 'undefined') r=5;
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
      if(fill) ctx.fill();
      if(stroke) ctx.stroke();
    }

    // update logic (sửa: đặt lại vị trí sau va chạm, đảm bảo chỉ 1 rAF)
    function update() {
  // di chuyển vợt
  let mv = (rightPressed ? 1 : 0) - (leftPressed ? 1 : 0);
  bat.x += mv * bat.speed;

  if (bat.x < 0) bat.x = 0;
  if (bat.x + bat.w > W) bat.x = W - bat.w;

  // --- VA CHẠM VỚI VỢT ---
  if (ball.vy > 0 && ball.y + ball.vy + ball.r >= bat.y) {
    if (ball.x + ball.r >= bat.x && ball.x - ball.r <= bat.x + bat.w) {

      const hitPos = (ball.x - (bat.x + bat.w / 2)) / (bat.w / 2);
      const newAngle = -Math.PI / 2 + hitPos * Math.PI / 3;
      const newSpeed = Math.min(3 + score * 0.015, 6);

      ball.vx = Math.cos(newAngle) * newSpeed;
      ball.vy = Math.sin(newAngle) * newSpeed;
      if (ball.vy > 0) ball.vy = -Math.abs(ball.vy);

      ball.y = bat.y - ball.r - 0.5;

      score += 1;
      bounceCount += 1;
      if (bounceCount >= 4) {
        bounceCount = 0;
        bat.speed = Math.min(bat.speed + 0.8, 12);
      }
      updateScore();
    }
  }

  // di chuyển bóng
  ball.x += ball.vx;
  ball.y += ball.vy;

  // --- VA CHẠM TƯỜNG: TRÁI / PHẢI ---
  if (ball.x - ball.r <= 0) {
    ball.x = ball.r;
    ball.vx *= -1;
  }
  else if (ball.x + ball.r >= W) {
    ball.x = W - ball.r;
    ball.vx *= -1;
  }

  // --- VA CHẠM TRẦN ---
  if (ball.y - ball.r <= 0) {
    ball.y = ball.r;
    ball.vy *= -1;
  }
}



      // di chuyển bóng
      ball.x += ball.vx;
      ball.y += ball.vy;
    }

    function updateScore(){ scoreEl.textContent = score; }

    function showGameOver(){
      running = false;
      // cancel RAF to prevent multiple loops
      if(rafId !== null){
        cancelAnimationFrame(rafId);
        rafId = null;
      }
      modalTitle.textContent = 'Bạn thua!';
      modalText.textContent = 'Điểm: ' + score;
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
    }

    function hideGameOver(){
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
    }

    function checkGameOver(){
      if(ball.y - ball.r > H){
        // show modal (non-blocking)
        showGameOver();
      }
    }

    function reset(){
      // cancel any running RAF first
      if(rafId !== null){
        cancelAnimationFrame(rafId);
        rafId = null;
      }

      score=0; bounceCount=0;

      bat.x = 10; bat.speed = config.batSpeed;
      ball.x = 60; ball.y = config.batY - 20;
      ball.vx = config.startVx * (Math.random() > 0.5 ? 1 : -1);
      ball.vy = config.startVy;

      // reset phím để tránh kẹt phím nếu đang mất focus
      leftPressed = false;
      rightPressed = false;

      updateScore();

      // hide modal if open
      hideGameOver();
    }

    // vòng lặp render
    function draw(){
      drawBackground();
      drawBat();
      drawBall();
    }

    function loop(){
      if(!running){
        rafId = null;
        return;
      }

      update();
      draw();
      checkGameOver();

      // đăng ký rAF tiếp theo
      rafId = requestAnimationFrame(loop);
    }

    // events
    window.addEventListener('keydown', e=>{
      if(e.key === 'ArrowLeft' || e.key === 'Left') leftPressed = true;
      if(e.key === 'ArrowRight' || e.key === 'Right') rightPressed = true;
    });
    window.addEventListener('keyup', e=>{
      if(e.key === 'ArrowLeft' || e.key === 'Left') leftPressed = false;
      if(e.key === 'ArrowRight' || e.key === 'Right') rightPressed = false;
    });

    // reset button: bắt đầu loop an toàn (chỉ 1 rAF)
    resetBtn.addEventListener('click', ()=>{
      reset();
      running = true;
      if(rafId === null) {
        rafId = requestAnimationFrame(loop);
      }
    });

    // modal controls
    playAgainBtn.addEventListener('click', ()=>{
      reset();
      running = true;
      if(rafId === null) rafId = requestAnimationFrame(loop);
    });
    closeModalBtn.addEventListener('click', ()=>{
      hideGameOver();
    });

    // Khi cửa sổ mất focus (ví dụ do alert/confirm, chuyển tab) -> reset trạng thái phím
    window.addEventListener("blur", () => {
      leftPressed = false;
      rightPressed = false;
    });

    // bắt đầu game lần đầu (một rAF duy nhất)
    reset();
    running = true;
    if(rafId === null) rafId = requestAnimationFrame(loop);

    // Gợi ý: nếu muốn chậm hơn, giảm config.startVx / startVy hoặc giảm bat.speed
  </script>
</body>
</html>
